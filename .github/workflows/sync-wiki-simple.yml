name: Simple Wiki Sync
on:
  push:
    branches: [ "main" ]
    paths:
      - "wiki/**"
      - ".github/workflows/sync-wiki-simple.yml"
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          echo "📦 Installing Python dependencies..."
          pip install requests

      - name: Create wiki content
        run: |
          echo "📝 Creating wiki content..."
          mkdir -p wiki-output
          
          # Create a simple Home.md for the wiki
          echo "# Yourl.Cloud Wiki" > wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "Welcome to the Yourl.Cloud project wiki!" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## 🚀 Quick Start" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "### Local Development" >> wiki-output/Home.md
          echo '```bash' >> wiki-output/Home.md
          echo 'git clone https://github.com/XDM-ZSBW/cloud-yourl.git' >> wiki-output/Home.md
          echo 'cd cloud-yourl' >> wiki-output/Home.md
          echo 'pip install -r requirements.txt' >> wiki-output/Home.md
          echo 'python app.py' >> wiki-output/Home.md
          echo '```' >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "### Cloud Run Deployment" >> wiki-output/Home.md
          echo '```bash' >> wiki-output/Home.md
          echo 'gcloud builds submit --config cloudbuild.yaml' >> wiki-output/Home.md
          echo '```' >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## 📚 Documentation" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "- **[README.md](README.md)** - Main project documentation" >> wiki-output/Home.md
          echo "- **[Wiki Source](https://github.com/XDM-ZSBW/cloud-yourl/tree/main/wiki)** - Wiki files" >> wiki-output/Home.md
          echo "- **[GitHub Wiki](https://github.com/XDM-ZSBW/cloud-yourl/wiki)** - Live wiki" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## 🔄 Wiki Sync Status" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "This wiki is automatically synchronized from the \`wiki/\` directory in the main repository." >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "**Last Sync**: $(date -u)" >> wiki-output/Home.md
          echo "**Source**: Main repository wiki/ directory" >> wiki-output/Home.md
          echo "**Method**: GitHub Actions automation" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## 🏗️ Architecture" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "- **Backend**: Python Flask 3.0.2" >> wiki-output/Home.md
          echo "- **WSGI Server**: Gunicorn/Waitress" >> wiki-output/Home.md
          echo "- **Deployment**: Google Cloud Run" >> wiki-output/Home.md
          echo "- **Domain**: Custom domain mapping support" >> wiki-output/Home.md
          echo "- **Security**: Friends and Family Guard ruleset" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## 📋 Current Status" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "✅ **Wiki Automation**: Implemented and working" >> wiki-output/Home.md
          echo "✅ **Cloud Run Support**: Full compatibility" >> wiki-output/Home.md
          echo "✅ **Domain Mapping**: Custom domain support" >> wiki-output/Home.md
          echo "✅ **Security**: Friends and Family Guard enabled" >> wiki-output/Home.md

      - name: Setup Git for wiki
        run: |
          echo "🔧 Setting up Git for wiki operations..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone or create wiki repo
        run: |
          echo "🔄 Setting up wiki repository..."
          
          # Try to clone existing wiki
          if git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki-repo 2>/dev/null; then
            echo "✅ Existing wiki repository cloned"
          else
            echo "🚀 Creating new wiki repository..."
            mkdir wiki-repo
            cd wiki-repo
            git init
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
            cd ..
          fi

      - name: Sync wiki content
        run: |
          echo "🔄 Syncing wiki content..."
          
          # Copy all wiki files
          cp -r wiki/* wiki-repo/
          cp wiki-output/Home.md wiki-repo/
          
          cd wiki-repo
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "📝 Changes detected, preparing to commit and push..."
            
            # Try to pull latest changes first to avoid conflicts
            echo "🔄 Pulling latest changes from remote..."
            if git pull origin main --no-edit 2>/dev/null; then
              echo "✅ Successfully pulled latest changes"
            else
              echo "ℹ️ No remote changes to pull or pull failed (continuing...)"
            fi
            
            # Add and commit changes
            git add -A
            git commit -m "chore(wiki): sync from main repo @ ${{ github.sha }}"
            
            # Try to push to main branch
            echo "🚀 Pushing changes to wiki repository..."
            if git push origin main 2>/dev/null; then
              echo "✅ Wiki updated successfully (pushed to main branch)"
            else
              # If push fails, try to force push (this will overwrite remote changes)
              echo "⚠️ Regular push failed, attempting force push..."
              if git push --force-with-lease origin main 2>/dev/null; then
                echo "✅ Wiki updated successfully (force pushed to main branch)"
              else
                echo "❌ Failed to push changes to wiki repository"
                exit 1
              fi
            fi
          else
            echo "ℹ️ No changes to commit"
          fi

      - name: Verify sync
        run: |
          echo "🔍 Verifying wiki sync..."
          if [ -d "wiki-repo" ]; then
            echo "📁 Wiki contents:"
            ls -la wiki-repo/
            echo ""
            echo "📄 Home.md preview:"
            head -20 wiki-repo/Home.md
            echo ""
            echo "🌿 Current branch:"
            cd wiki-repo && git branch -a
            echo ""
            echo "📋 Recent commits:"
            git log --oneline -3
          fi
          echo "✅ Wiki sync verification complete"
