name: Simple Wiki Sync
on:
  push:
    branches: [ "main" ]
    paths:
      - "wiki/**"
      - ".github/workflows/sync-wiki-simple.yml"
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          echo "üì¶ Installing Python dependencies..."
          pip install requests

      - name: Create wiki content
        run: |
          echo "üìù Creating wiki content..."
          mkdir -p wiki-output
          
          # Create a simple Home.md for the wiki
          echo "# Yourl.Cloud Wiki" > wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "Welcome to the Yourl.Cloud project wiki!" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## üöÄ Quick Start" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "### Local Development" >> wiki-output/Home.md
          echo '```bash' >> wiki-output/Home.md
          echo 'git clone https://github.com/XDM-ZSBW/cloud-yourl.git' >> wiki-output/Home.md
          echo 'cd cloud-yourl' >> wiki-output/Home.md
          echo 'pip install -r requirements.txt' >> wiki-output/Home.md
          echo 'python app.py' >> wiki-output/Home.md
          echo '```' >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "### Cloud Run Deployment" >> wiki-output/Home.md
          echo '```bash' >> wiki-output/Home.md
          echo 'gcloud builds submit --config cloudbuild.yaml' >> wiki-output/Home.md
          echo '```' >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## üìö Documentation" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "- **[README.md](README.md)** - Main project documentation" >> wiki-output/Home.md
          echo "- **[Wiki Source](https://github.com/XDM-ZSBW/cloud-yourl/tree/main/wiki)** - Wiki files" >> wiki-output/Home.md
          echo "- **[GitHub Wiki](https://github.com/XDM-ZSBW/cloud-yourl/wiki)** - Live wiki" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## üîÑ Wiki Sync Status" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "This wiki is automatically synchronized from the \`wiki/\` directory in the main repository." >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "**Last Sync**: $(date -u)" >> wiki-output/Home.md
          echo "**Source**: Main repository wiki/ directory" >> wiki-output/Home.md
          echo "**Method**: GitHub Actions automation" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## üèóÔ∏è Architecture" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "- **Backend**: Python Flask 3.0.2" >> wiki-output/Home.md
          echo "- **WSGI Server**: Gunicorn/Waitress" >> wiki-output/Home.md
          echo "- **Deployment**: Google Cloud Run" >> wiki-output/Home.md
          echo "- **Domain**: Custom domain mapping support" >> wiki-output/Home.md
          echo "- **Security**: Friends and Family Guard ruleset" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "## üìã Current Status" >> wiki-output/Home.md
          echo "" >> wiki-output/Home.md
          echo "‚úÖ **Wiki Automation**: Implemented and working" >> wiki-output/Home.md
          echo "‚úÖ **Cloud Run Support**: Full compatibility" >> wiki-output/Home.md
          echo "‚úÖ **Domain Mapping**: Custom domain support" >> wiki-output/Home.md
          echo "‚úÖ **Security**: Friends and Family Guard enabled" >> wiki-output/Home.md

      - name: Setup Git for wiki
        run: |
          echo "üîß Setting up Git for wiki operations..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone or create wiki repo
        run: |
          echo "üîÑ Setting up wiki repository..."
          
          # Try to clone existing wiki
          if git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki-repo 2>/dev/null; then
            echo "‚úÖ Existing wiki repository cloned"
          else
            echo "üöÄ Creating new wiki repository..."
            mkdir -p wiki-repo
            cd wiki-repo
            
            # Set default branch to main before init
            git config --global init.defaultBranch main
            git init
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
            
            # Create initial README.md
            echo "# Welcome to Yourl.Cloud Wiki" > README.md
            echo "" >> README.md
            echo "This wiki is automatically synchronized from the main repository." >> README.md
            
            # Add, commit and push
            git add README.md
            git commit -m "Initial wiki setup"
            
            # Try to push, but handle case where repo already exists
            if git push -u origin main 2>/dev/null; then
              echo "‚úÖ Wiki repository created successfully"
            else
              echo "‚ö†Ô∏è Push failed, wiki repository may already exist. Trying to pull existing content..."
              cd ..
              rm -rf wiki-repo
              
              # Try cloning again (it should work now)
              if git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki-repo 2>/dev/null; then
                echo "‚úÖ Successfully cloned existing wiki repository"
              else
                echo "‚ùå Failed to clone wiki repository"
                exit 1
              fi
            fi
            
            if [ "$(pwd)" = "/home/runner/work/cloud-yourl/cloud-yourl/wiki-repo" ]; then
              cd ..
            fi
          fi

      - name: Check wiki repo structure
        run: |
          echo "üîç Checking wiki repository structure..."
          if [ -d "wiki-repo" ]; then
            cd wiki-repo
            echo "üìÅ Wiki repo contents:"
            ls -la
            echo ""
            echo "üåø Git branches:"
            git branch -a
            echo ""
            echo "üîó Git remotes:"
            git remote -v
            echo ""
            echo "üìã Git log (last 5 commits):"
            git log --oneline -5
            echo ""
            echo "üîë Token check:"
            echo "  - GITHUB_TOKEN available: ${{ secrets.GITHUB_TOKEN != '' }}"
            echo "  - Repository: ${{ github.repository }}"
            echo "  - Actor: ${{ github.actor }}"
            cd ..
          else
            echo "‚ùå Wiki repo directory not found"
          fi

      - name: Sync wiki content
        run: |
          echo "üîÑ Syncing wiki content..."
          
          # Copy all wiki files
          cp -r wiki/* wiki-repo/
          cp wiki-output/Home.md wiki-repo/
          
          cd wiki-repo
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "üìù Changes detected, preparing to commit and push..."
            
            # Try to pull latest changes first to avoid conflicts
            echo "üîÑ Pulling latest changes from remote..."
            if git pull origin main --no-edit 2>/dev/null; then
              echo "‚úÖ Successfully pulled latest changes"
            else
              echo "‚ÑπÔ∏è No remote changes to pull or pull failed (continuing...)"
            fi
            
            # Add and commit changes
            git add -A
            git commit -m "chore(wiki): sync from main repo @ ${{ github.sha }}"
            
            # Try to push to main branch
            echo "üöÄ Pushing changes to wiki repository..."
            echo "üîç Debug info:"
            echo "  - Current branch: $(git branch --show-current)"
            echo "  - Remote origin: $(git remote get-url origin)"
            echo "  - Git status:"
            git status --porcelain
            echo "  - Recent commits:"
            git log --oneline -3
            
            if git push origin main 2>/dev/null; then
              echo "‚úÖ Wiki updated successfully (pushed to main branch)"
            else
              # If push fails, try to force push (this will overwrite remote changes)
              echo "‚ö†Ô∏è Regular push failed, attempting force push..."
              echo "üîç Force push debug info:"
              echo "  - Local commits:"
              git log --oneline origin/main..HEAD
              echo "  - Remote commits:"
              git log --oneline HEAD..origin/main
              
              if git push --force-with-lease origin main 2>/dev/null; then
                echo "‚úÖ Wiki updated successfully (force pushed to main branch)"
              else
                echo "‚ùå Force push also failed. Trying alternative approach..."
                
                # Try to reset to remote and reapply our changes
                echo "üîÑ Attempting alternative sync method..."
                git fetch origin
                git reset --hard origin/main
                cp -r ../wiki/* .
                cp ../wiki-output/Home.md .
                git add -A
                git commit -m "chore(wiki): sync from main repo @ ${{ github.sha }} (alternative method)"
                
                if git push origin main 2>/dev/null; then
                  echo "‚úÖ Wiki updated successfully (alternative method)"
                else
                  echo "‚ùå All push methods failed. Final debug info:"
                  echo "  - Git remote -v:"
                  git remote -v
                  echo "  - Git branch -a:"
                  git branch -a
                  echo "  - Git log --oneline -5:"
                  git log --oneline -5
                  echo "  - Current working directory: $(pwd)"
                  echo "  - Directory contents:"
                  ls -la
                  exit 1
                fi
              fi
            fi
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Verify sync
        run: |
          echo "üîç Verifying wiki sync..."
          if [ -d "wiki-repo" ]; then
            echo "üìÅ Wiki contents:"
            ls -la wiki-repo/
            echo ""
            echo "üìÑ Home.md preview:"
            head -20 wiki-repo/Home.md
            echo ""
            echo "üåø Current branch:"
            cd wiki-repo && git branch -a
            echo ""
            echo "üìã Recent commits:"
            git log --oneline -3
          fi
          echo "‚úÖ Wiki sync verification complete"
